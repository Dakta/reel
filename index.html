<!doctype html>
<html>
<head>
	<title></title>
    <link rel="stylesheet" href="/css/skeleton.css" />
    <link rel="stylesheet" href="/css/snap.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <script src="/js/jquery-2.1.1.min.js"></script>
    <script src="/js/mediaCheck-min.js"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimal-ui">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body>
<div class="snap-drawers">
    <aside id="groups" class="sidebar scrollable snap-drawer snap-drawer-left">
        <ul>
            <li>
                <ul>
                    <li>Acquaintences</li>
                    <li>Friends</li>
                    <li>Close Friends</li>
                    <li>Family</li>
                </ul>
            </li>
        </ul>
    </aside>

    <aside id="messages" class="sidebar scrollable snap-drawer snap-drawer-right">
        <ul>
            <li>
                <h1>Favorites</h1>
                <ul>
                    <li>Acquaintences</li>
                    <li>Friends</li>
                    <li>Close Friends</li>
                    <li>Family</li>
                </ul>
            </li>
            <li>
                <h1>Recent</h1>
                <ul>
                    <li>
                        <span class="status online"></span>
                        <img class="avatar" src="/img/avatar.png" />
                        <span class="name">Jeff</span>
                    </li>
                    <li>
                        <span class="status offline"></span>
                        <img class="avatar" src="/img/avatar.png" />
                        <span class="name">Cole</span>
                    </li>
                    <li>
                        <span class="status online"></span>
                        <img class="avatar" src="/img/avatar.png" />
                        <span class="name">Lily</span>
                    </li>
                    <li>
                        <span class="status away"></span>
                        <img class="avatar" src="/img/avatar.png" />
                        <span class="name">Andrew</span>
                    </li>
                </ul>
            </li>
            <li>
                <h1>Online</h1>
                <ul>
                    <li>
                        <span class="status online"></span>
                        <img class="avatar" src="/img/avatar.png" />
                        <span class="name">Jeff</span>
                    </li>
                    <li>
                        <span class="status offline"></span>
                        <img class="avatar" src="/img/avatar.png" />
                        <span class="name">Cole</span>
                    </li>
                    <li>
                        <span class="status online"></span>
                        <img class="avatar" src="/img/avatar.png" />
                        <span class="name">Lily</span>
                    </li>
                    <li>
                        <span class="status away"></span>
                        <img class="avatar" src="/img/avatar.png" />
                        <span class="name">Andrew</span>
                    </li>
                </ul>
            </li>
        </ul>
    </aside>
</div>

<div id="content" class="snap-content">
    <div id="main" class="container">
        <header class="title eleven columns alpha omega">
            <a href="#" id="open-left" class="with-drawers">Groups</a>
            (Current group.)
            <a href="#" id="open-right" class="with-drawers">Messages</a>
        </header>
            
        <section id="main" class="eleven columns">
            <pre id="userlist"><code></code></pre>
            <ul id="chats"></ul>
            <form action="">
                <input id="m" autocomplete="off" /><button>Send</button>
            </form>
        </section>
    </div>
</div>

<script src="/js/snap.js"></script>
<script type="text/javascript">
    var snapper = new Snap({
        element: document.getElementById('content'),
        maxPosition: 160,
        minPosition: -160
    });

    $('#open-left').click(function(){
    	snapper.open('left');
    });
    $('#open-right').click(function(){
    	snapper.open('right');
    });

    mediaCheck({
      media: '(max-width: 768px)',
      entry: function() {
        snapper.close();
        snapper.enable();
      },
      exit: function() {
        snapper.close();
        snapper.disable();
      },
      both: function() {
        console.log('changing state');
      }
    });

</script>

<script src="/socket.io/socket.io.js"></script>
<script>
  var socket = io();

  var profile = {};

  function appendMessage(name, msg) {
    return $('<li>').addClass('unconfirmed').text(name + ': ' + msg).appendTo($('#chats'));
  }
    
  $('form').submit(function(){
    var data = {
      'uid': Date.now(),
      'message': $('#m').val()
    };

    // inject the message, but mark it as unconfirmed and keep track of it
    // in case we have high latency
    var $msgline = appendMessage(profile.display_name, data.message);
    
    socket.emit('message', data, function(response) {
        // on success, we unhide the message
        $msgline.removeClass('unconfirmed');
    });
    $('#m').val('');
    return false;
  });
  
  socket.on('set_self', function(prof) {
      profile = prof;
  });
  
  socket.on('userlist', function(userlist) {
      var $messages = $('#messages ul');
      
      // let's just redraw everything
      $messages.empty();
      
      // rebuild
      $.each(userlist, function(status, users) {
          var $status = $('<li><h1>'+status+'</h1></li>').appendTo($messages);
          var $listed = $('<ul>').appendTo($status);
          $.each(users, function(id, user) {
              $('\
                    <li>\
                        <span class="status '+status+'"></span>\
                        <img class="avatar" src="'+user.avatar_url+'" />\
                        <span class="name">'+user.display_name+'</span>\
                    </li>').appendTo($listed);
          });
      });
      // for debug
/*       $('#userlist').text(JSON.stringify(userlist, undefined, 2)); */
  });
  
  socket.on('message', function(data){
      appendMessage(data.pseudo, data.message);
  });
  
  socket.on('raw', function(data){
      console.log(data);
  });

</script>

</body>
</html>
