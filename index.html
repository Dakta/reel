<!doctype html>
<html>
<head>
	<title></title>
    <link rel="stylesheet" href="/css/skeleton.css" />
    <link rel="stylesheet" href="/css/snap.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <script src="/socket.io/socket.io.js"></script>
<!--     <script src="/js/vendor/socket.io-client/socket.io.js"></script> -->
    <script src="/js/vendor/jquery/dist/jquery.js"></script>
    <script src="/js/vendor/handlebars/handlebars.js"></script>
    
    <script src="/js/vendor/ember/ember.js"></script>
<!--     <script src="/js/vendor/ember-data/ember-data.min.js"></script> -->
    <script src="/js/vendor/ember-sockets/dist/ember-sockets.js"></script>
    
    <script src="/js/mediaCheck-min.js"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimal-ui">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>

<body><script type="text/x-handlebars" data-template-name="index">

<div class="snap-drawers">
    <aside id="groups" class="sidebar scrollable snap-drawer snap-drawer-left">
        <ul>
            <li>
                <ul>
                    <li>Acquaintences</li>
                    <li>Friends</li>
                    <li>Close Friends</li>
                    <li>Family</li>
                </ul>
            </li>
        </ul>
    </aside>

    <aside id="messages" class="sidebar scrollable snap-drawer snap-drawer-right">
        <ul>
            {{#each userlist}}
            <li>
                <h1>{{name}}</h1>
                <ul>
                    {{#each data}}
                    <li>
                        <span {{bind-attr class=":status :online"}}></span>
                        <img class="avatar" {{bind-attr src=avatar_url}} />
                        <span class="name">{{display_name}}</span>
                    </li>
                    {{/each}}
                </ul>
            </li>
            {{/each}}

            <li>
                <h1>Favorites</h1>
                <ul>
                    <li>Acquaintences</li>
                    <li>Friends</li>
                    <li>Close Friends</li>
                    <li>Family</li>
                </ul>
            </li>
            <li>
                <h1>Recent</h1>
                <ul>
                    <li>
                        <span class="status online"></span>
                        <img class="avatar" src="/img/avatar.png" />
                        <span class="name">Jeff</span>
                    </li>
                    <li>
                        <span class="status offline"></span>
                        <img class="avatar" src="/img/avatar.png" />
                        <span class="name">Cole</span>
                    </li>
                    <li>
                        <span class="status online"></span>
                        <img class="avatar" src="/img/avatar.png" />
                        <span class="name">Lily</span>
                    </li>
                    <li>
                        <span class="status away"></span>
                        <img class="avatar" src="/img/avatar.png" />
                        <span class="name">Andrew</span>
                    </li>
                </ul>
            </li>
            <li>
                <h1>Online</h1>
                <ul>
                    <li>
                        <span class="status online"></span>
                        <img class="avatar" src="/img/avatar.png" />
                        <span class="name">Jeff</span>
                    </li>
                    <li>
                        <span class="status offline"></span>
                        <img class="avatar" src="/img/avatar.png" />
                        <span class="name">Cole</span>
                    </li>
                    <li>
                        <span class="status online"></span>
                        <img class="avatar" src="/img/avatar.png" />
                        <span class="name">Lily</span>
                    </li>
                    <li>
                        <span class="status away"></span>
                        <img class="avatar" src="/img/avatar.png" />
                        <span class="name">Andrew</span>
                    </li>
                </ul>
            </li>
        </ul>
    </aside>
</div>

<div id="content" class="snap-content">
    <div id="main" class="container">
        <header class="title eleven columns alpha omega">
            <a href="#" id="open-left" class="with-drawers">Groups</a>
            (Current group.)
            <a href="#" id="open-right" class="with-drawers">Messages</a>
        </header>
            
        <section id="main" class="eleven columns">
            <ul id="chats">
            {{#each messages}}
                <li {{bind-attr class="unconfirmed"}}>{{display_name}}: {{message}}</li>
            {{/each}}
            </ul>
            <form {{action "sendMsg" lastMsg on="submit"}}>
                {{input valueBinding="lastMsg" type="text" autocomplete="off"}}
                <button>Send</button>
            </form>
        </section>
        
    </div>
</div>

</script><!-- ends handlebars -->


<script src="/js/snap.js"></script>
<script type="text/javascript">
    var snapper = new Snap({
        element: document.getElementById('content'),
        maxPosition: 160,
        minPosition: -160
    });

    $('#open-left').click(function(){
    	snapper.open('left');
    });
    $('#open-right').click(function(){
    	snapper.open('right');
    });

    mediaCheck({
      media: '(max-width: 768px)',
      entry: function() {
        snapper.close();
        snapper.enable();
      },
      exit: function() {
        snapper.close();
        snapper.disable();
      },
      both: function() {
        console.log('changing state');
      }
    });

</script>

<script type="text/javascript">
    // App
    Reel = Em.Application.create({
        Socket: EmberSockets.extend({
            controllers: ['index'],
            autoConnect: true
        })
    });
    
    // Routes
/*
    Reel.Router.map(function() {
        this.resource('front', { path: '/' });
    });
*/

    Reel.Serializable = Ember.Mixin.create({
        serialize: function ()
        {
            var result = {};
            for (var key in $.extend(true, {}, this))
            {
                // Skip these
                if (key === 'isInstance' ||
                key === 'isDestroyed' ||
                key === 'isDestroying' ||
                key === 'concatenatedProperties' ||
                typeof this[key] === 'function')
                {
                    continue;
                }
                result[key] = this[key];
            }
            return result;
        }
    });
    
    // Message Model that we can serialize
    Reel.Message = Ember.Object.extend(Reel.Serializable, {
/*
        'uid': null,
        'hidden': true, // hide to begin with, until we confirm
        'display_name': null,
        'message': null
*/
    });

    Reel.IndexController = Em.Controller.extend({

        /**
         * @property actions
         * @type {Object}
         */
        actions: {

            /**
             * @method cherryPickName
             * @emit cherryPickName
             * @return {void}
             */
            sendMsg: function(message) {
                console.log('sendMsg', this.get('lastMsg'));
                
                var data = Reel.Message.create({
                  'uid': Date.now(),
                  'unconfirmed': true, // hide to begin with, until we confirm
                  'display_name': this.profile.display_name,
                  'message': message
                });
            
                // inject the message, but mark it as unconfirmed and keep track of it
                // in case we have high latency
/*                 var $msgline = appendMessage(profile.display_name, data.message); */
                
                this.messages.pushObject(data)
/*                 this.messages.set(data.uid, data); */
                var that = this;

/*                 data.set('hidden', null); */
                
                this.socket.emit('msg', data, function(response) {
/*                     var $msgline = appendMessage(profile.display_name, data.message); */
/*                     console.log(that.messages.findBy('uid', response.uid)); // .set('hidden', false); */
                    data.set('unconfirmed', false);
                    console.log('response!', response);
                });
                
                // clear text input
                this.set('last_message', '');
                
/*
                this.socket.emit('message', data, function(response) {
                    // on success, we unhide the message
                    that.messages.replace(messages.findBy('uid', data.uid), data);
                });
*/
            },
/*
            updateLastMsg: function(message) {
                this.set('lastMsg', message);
            },
*/
        },

        /**
         * @property sockets
         * @type {Object}
         */
        sockets: {

            // Update the property from the data received.
//            cherryPickedName: ['name', 'age'],

            // Update the property using a callback.
            userlist: function(userlist) {
                console.log('got userlist', userlist);
                this.set('title', "well, this is wrong.");
                this.set('userlist', userlist);
            },
            
            msg: function(data) {
                console.log('got message', data);
                this.messages.pushObject(Reel.Message.create(data));
/*                 this.messages.set(data.uid, data); */
            },

            set_self: function(prof) {
                console.log('got self', prof);
                this.profile = prof;
            },
            
            // When EmberSockets makes a connection to the Socket.IO server.
            connect: function() {
                console.log('EmberSockets has connected...');
            },

            // When EmberSockets disconnects from the Socket.IO server.
            disconnect: function() {
                console.log('EmberSockets has disconnected...');
            }

        },


        /**
         * @property userlist
         * @type {Array}
         */
        userlist: [],
        
        /**
         * @ property last_message
         * @type {String}
         */
        lastMsg: "",
        
        messages: Ember.A(),
/*         messages: Ember.Map.create(), */
        
        profile: {}

    });


</script>

<script>

/*
  var socket = io();

  var profile = {};

  function appendMessage(name, msg) {
    return $('<li>').addClass('unconfirmed').text(name + ': ' + msg).appendTo($('#chats'));
  }
    
  $('form').submit(function(){
    var data = {
      'uid': Date.now(),
      'message': $('#m').val()
    };

    // inject the message, but mark it as unconfirmed and keep track of it
    // in case we have high latency
    var $msgline = appendMessage(profile.display_name, data.message);
    
    socket.emit('message', data, function(response) {
        // on success, we unhide the message
        $msgline.removeClass('unconfirmed');
    });
    $('#m').val('');
    return false;
  });
  
  socket.on('set_self', function(prof) {
      profile = prof;
  });


  socket.on('userlist', function(userlist) {
      var $messages = $('#messages ul');
      
      // let's just redraw everything
      $messages.empty();
      
      // rebuild
      $.each(userlist, function(status, users) {
          var $status = $('<li><h1>'+status+'</h1></li>').appendTo($messages);
          var $listed = $('<ul>').appendTo($status);
          $.each(users, function(id, user) {
              $('\
                    <li>\
                        <span class="status '+status+'"></span>\
                        <img class="avatar" src="'+user.avatar_url+'" />\
                        <span class="name">'+user.display_name+'</span>\
                    </li>').appendTo($listed);
          });
      });
      // for debug
      $('#userlist').text(JSON.stringify(userlist, undefined, 2));
  });
  

  socket.on('message', function(data){
      appendMessage(data.pseudo, data.message);
  });
  
  socket.on('raw', function(data){
      console.log(data);
  });

*/

</script>

</body>
</html>
